>ä»£ç†æ¨¡å¼æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„è®¾è®¡æ¨¡å¼åœ¨Springæ¡†æ¶ä¸­ç»å¸¸ç”¨åˆ°ï¼Œå¯¹è¿™ä¸ªæ¨¡å¼çš„å­¦ä¹ æœ‰åŠ©äºè‡ªå·±å»ç†è§£Springï¼Œèˆ’æœï¼ğŸ¤” 

## ä»£ç†æ¨¡å¼æ¦‚è¿°
 ---
>é€šè¿‡ä»£ç†æ§åˆ¶å¯¹è±¡çš„è®¿é—®,**å¯ä»¥è¯¦ç»†è®¿é—®æŸä¸ªå¯¹è±¡çš„æ–¹æ³•**ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•è°ƒç”¨å¤„ç†ï¼Œæˆ–è°ƒç”¨åå¤„ç†ã€‚å³(AOPå¾®å®ç°)  ,AOPæ ¸å¿ƒæŠ€æœ¯é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚è¿™é‡Œä½¿ç”¨åˆ°ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªæ€æƒ³ï¼ˆå¼€é—­åŸåˆ™ï¼‰:ä¸è¦éšæ„å»ä¿®æ”¹åˆ«äººå·²ç»å†™å¥½çš„ä»£ç æˆ–è€…æ–¹æ³•,å¦‚æœéœ€æ”¹ä¿®æ”¹,å¯ä»¥é€šè¿‡ä»£ç†çš„æ–¹å¼æ¥æ‰©å±•è¯¥æ–¹æ³•ã€‚

ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ä»£ç†çš„ä½œç”¨:å‡è®¾æˆ‘ä»¬æƒ³é‚€è¯·ä¸€ä½æ˜æ˜Ÿ,é‚£ä¹ˆå¹¶ä¸æ˜¯ç›´æ¥è¿æ¥æ˜æ˜Ÿ,è€Œæ˜¯è”ç³»æ˜æ˜Ÿçš„ç»çºªäºº,æ¥è¾¾åˆ°åŒæ ·çš„ç›®çš„.æ˜æ˜Ÿå°±æ˜¯ä¸€ä¸ªç›®æ ‡å¯¹è±¡,ä»–åªè¦è´Ÿè´£æ´»åŠ¨ä¸­çš„èŠ‚ç›®,è€Œå…¶ä»–çç¢çš„äº‹æƒ…å°±äº¤ç»™ä»–çš„ä»£ç†äºº(ç»çºªäºº)æ¥è§£å†³.è¿™å°±æ˜¯ä»£ç†æ€æƒ³åœ¨ç°å®ä¸­çš„ä¸€ä¸ªä¾‹å­

![](https://images2015.cnblogs.com/blog/790334/201701/790334-20170116124522880-1137330008.png)

##### ä»£ç†æ¨¡å¼åº”ç”¨åœºæ™¯
SpringAOPã€äº‹ç‰©åŸç†ã€æ—¥å¿—æ‰“å°ã€æƒé™æ§åˆ¶ã€è¿œç¨‹è°ƒç”¨ã€å®‰å…¨ä»£ç† å¯ä»¥éšè”½çœŸå®è§’è‰²ã€‚

### ä»£ç†çš„åˆ†ç±»
* é™æ€ä»£ç†(é™æ€å®šä¹‰ä»£ç†ç±»)
* åŠ¨æ€ä»£ç†(åŠ¨æ€ç”Ÿæˆä»£ç†ç±»)
	* Jdkè‡ªå¸¦åŠ¨æ€ä»£ç†
	* Cglib...

## é™æ€ä»£ç†
---
ä»€ä¹ˆæ˜¯é™æ€ä»£ç†ï¼Ÿ

ç”±ç¨‹åºå‘˜åˆ›å»ºæˆ–å·¥å…·ç”Ÿæˆä»£ç†ç±»çš„æºç ï¼Œå†ç¼–è¯‘ä»£ç†ç±»ã€‚æ‰€è°“é™æ€ä¹Ÿå°±æ˜¯åœ¨ç¨‹åºè¿è¡Œå‰å°±å·²ç»å­˜åœ¨ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œä»£ç†ç±»å’Œå§”æ‰˜ç±»çš„å…³ç³»åœ¨è¿è¡Œå‰å°±ç¡®å®šäº†ã€‚**éœ€è¦ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡**ã€‚

æ ¸å¿ƒæ­¥éª¤ï¼š
* åˆ›å»ºæ¥å£å®ç°æ¥å£
* åˆ›å»ºä»£ç†ç±»å¤„ç†ç›®æ ‡å¯¹è±¡å®ç°åŠŸèƒ½æ‰©å±•
* è¿è¡Œä¸»ç±»æ–¹æ³•

âœğŸ»ä¸Šä»£ç ï¼š
```java
/**
 * @author xianglei
 * é™æ€ä»£ç† æ¨¡æ‹Ÿæ•°æ®åº“å­˜å‚¨
 */
public interface UserDao {
    void add();
}
/**
 * @author xianglei
 * Dao å®ç°ç±»
 */
public class UserDaoImpl  implements UserDao{
    @Override
    public void add() {
        System.out.println("å­˜å…¥ä¸€æ¡æ•°æ®ï¼");
    }
}
/**
 * @author xianglei
 * åˆ›å»ºä»£ç†ç±»
 */
public class UserDaoProxy implements UserDao {
    private UserDao object;
    /**
     * åˆ›å»ºéœ€è¦è¢«ä»£ç†çš„å¯¹è±¡
     *
     */
    public UserDaoProxy(UserDao o){
      this.object=o;
    }

    @Override
    public void add() {
        System.out.println("å¼€å¯äº‹åŠ¡");
        object.add();
        System.out.println("å…³é—­äº‹åŠ¡");
    }
}

/**
 * @author xianglei
 */
public class Client {
    public static void main(String[] args) {
        UserDao userDao=new UserDaoImpl();
        UserDaoProxy userDaoProxy=new UserDaoProxy(userDao);
        userDaoProxy.add();
    }
}

```
ğŸ™‹æ³¨æ„ï¼š
1.é™æ€ä»£ç†å¯ä»¥åšåˆ°åœ¨ä¸ä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½å‰æä¸‹,å¯¹ç›®æ ‡åŠŸèƒ½æ‰©å±•.
2.ç¼ºç‚¹:å› ä¸ºä»£ç†å¯¹è±¡éœ€è¦ä¸ç›®æ ‡å¯¹è±¡å®ç°ä¸€æ ·çš„æ¥å£,æ‰€ä»¥ä¼šæœ‰å¾ˆå¤šä»£ç†ç±»,ç±»å¤ªå¤š.åŒæ—¶,ä¸€æ—¦æ¥å£å¢åŠ æ–¹æ³•,ç›®æ ‡å¯¹è±¡ä¸ä»£ç†å¯¹è±¡éƒ½è¦ç»´æŠ¤.

## åŠ¨æ€ä»£ç†
---
1. ä»£ç†å¯¹è±¡,ä¸éœ€è¦å®ç°æ¥å£
2. ä»£ç†å¯¹è±¡çš„ç”Ÿæˆ,æ˜¯åˆ©ç”¨JDKçš„API,åŠ¨æ€çš„åœ¨å†…å­˜ä¸­æ„å»ºä»£ç†å¯¹è±¡(éœ€è¦æˆ‘ä»¬æŒ‡å®šåˆ›å»ºä»£ç†å¯¹è±¡/ç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£çš„ç±»å‹)
3. åŠ¨æ€ä»£ç†ä¹Ÿå«åš:JDKä»£ç†,æ¥å£ä»£ç†

### JDKåŠ¨æ€ä»£ç†
>åŸç†ï¼šæ˜¯æ ¹æ®ç±»åŠ è½½å™¨å’Œæ¥å£åˆ›å»ºä»£ç†ç±»ï¼ˆæ­¤ä»£ç†ç±»æ˜¯æ¥å£çš„å®ç°ç±»ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨æ¥å£ é¢å‘æ¥å£ç”Ÿæˆä»£ç†ï¼Œä½äºjava.lang.reflectåŒ…ä¸‹ï¼‰

æ ¸å¿ƒæ­¥éª¤ï¼š
* åˆ›å»ºæ¥å£å®ç°æ¥å£æ–¹æ³•
* åˆ›å»ºä»£ç†ç±»å®ç° InvocationHandler é‡å†™ invoke æ–¹æ³• è¿”å›ç›®æ ‡å¯¹è±¡
* æ‹¿åˆ°ä»£ç†ç±»å¯¹è±¡ï¼Œé€šè¿‡åå°„æœºåˆ¶è·å–åˆ›å»ºå¯¹è±¡

âœğŸ»ä¸Šä»£ç :
```java
/**
 * @author xianglei
 * åˆ›å»ºdaoæ¥å£
 */
public interface UserDao {
     public void add();
}
/**
 * @author xianglei
 * å®ç°æ¥å£
 */
public class UserDaoImpl implements UserDao {
    @Override
    public void add() {
        System.out.println("å­˜å…¥æ•°æ®");
    }
}
/**
 * @author xianglei
 * ä½¿ç”¨JDKå®ç°åŠ¨æ€ä»£ç†
 */
public class InvocationHandlerImpl implements InvocationHandler {
    private Object target;

    /**
     * è¿™å…¶å®ä¸šåŠ¡å®ç°ç±»å¯¹è±¡ï¼Œç”¨æ¥è°ƒç”¨å…·ä½“çš„ä¸šåŠ¡æ–¹æ³•
     * é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ç›®æ ‡å¯¹è±¡
     */

    public InvocationHandlerImpl(Object target) {
        this.target = target;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        Object result = null;
        System.out.println("å¼€å¯äº‹åŠ¡");
        result = method.invoke(target, args);
        System.out.println("å…³é—­äº‹åŠ¡");
        return result;
    }

    public static void main(String[] args) {

        UserDao userDao = new UserDaoImpl();
        InvocationHandlerImpl invocationHandler = new InvocationHandlerImpl(userDao);
        ClassLoader loader = userDao.getClass().getClassLoader();
        Class<?>[] interfaces = userDao.getClass().getInterfaces();
        try {
            /**
             * ä¸€ä¸ªå°é”™è¯¯ åå°„æ‹¿æ¥å£çš„æ—¶å€™å†™é”™å¯¹è±¡äº† (â”¬ï¼¿â”¬)
             */
            UserDao o = (UserDao) Proxy.newProxyInstance(loader, interfaces, invocationHandler);
            o.add();
        }catch (Exception e){
            System.out.println(e.getMessage());
        }


    }
}

```
ğŸ™‹æ³¨æ„ï¼š

ä»£ç†å¯¹è±¡ä¸éœ€è¦å®ç°æ¥å£,ä½†æ˜¯ç›®æ ‡å¯¹è±¡ä¸€å®šè¦**å®ç°æ¥å£**,å¦åˆ™ä¸èƒ½ç”¨åŠ¨æ€ä»£ç†ã€‚JDKåŠ¨æ€ä»£ç†åªèƒ½å¯¹å®ç°äº†æ¥å£çš„ç±»ç”Ÿæˆä»£ç†ï¼Œè€Œä¸èƒ½é’ˆå¯¹ç±» ã€‚

## CgLibåŠ¨æ€ä»£ç†
---
>åŸç†ï¼šåˆ©ç”¨asmå¼€æºåŒ…ï¼Œå¯¹ä»£ç†å¯¹è±¡ç±»çš„classæ–‡ä»¶åŠ è½½è¿›æ¥ï¼Œé€šè¿‡ä¿®æ”¹å…¶å­—èŠ‚ç ç”Ÿæˆå­ç±»æ¥å¤„ç†ã€‚ä¸Šé¢çš„é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†æ¨¡å¼éƒ½æ˜¯è¦æ±‚ç›®æ ‡å¯¹è±¡æ˜¯å®ç°ä¸€ä¸ªæ¥å£çš„ç›®æ ‡å¯¹è±¡,ä½†æ˜¯æœ‰æ—¶å€™ç›®æ ‡å¯¹è±¡åªæ˜¯ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡,å¹¶æ²¡æœ‰å®ç°ä»»ä½•çš„æ¥å£,è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨ä»¥ç›®æ ‡å¯¹è±¡å­ç±»çš„æ–¹å¼ç±»å®ç°ä»£ç†ã€‚

Cglibä»£ç†,ä¹Ÿå«ä½œå­ç±»ä»£ç†,å®ƒæ˜¯åœ¨å†…å­˜ä¸­æ„å»ºä¸€ä¸ª**å­ç±»å¯¹è±¡**ä»è€Œå®ç°å¯¹ç›®æ ‡å¯¹è±¡åŠŸèƒ½çš„æ‰©å±•.

* JDKçš„åŠ¨æ€ä»£ç†æœ‰ä¸€ä¸ªé™åˆ¶,å°±æ˜¯ä½¿ç”¨åŠ¨æ€ä»£ç†çš„å¯¹è±¡å¿…é¡»å®ç°**ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£**,å¦‚æœæƒ³ä»£ç†æ²¡æœ‰å®ç°æ¥å£çš„ç±»,å°±å¯ä»¥ä½¿ç”¨Cglibå®ç°.
* Cglibæ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜æ€§èƒ½çš„ä»£ç ç”ŸæˆåŒ…,å®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸæ‰©å±•javaç±»ä¸å®ç°javaæ¥å£.å®ƒå¹¿æ³›çš„è¢«è®¸å¤šAOPçš„æ¡†æ¶ä½¿ç”¨,ä¾‹å¦‚Spring AOPå’Œsynaop,ä¸ºä»–ä»¬æä¾›æ–¹æ³•çš„interception(æ‹¦æˆª)
* CglibåŒ…çš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå°è€Œå—çš„å­—èŠ‚ç å¤„ç†**æ¡†æ¶ASM**æ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±».ä¸é¼“åŠ±ç›´æ¥ä½¿ç”¨ASM,å› ä¸ºå®ƒè¦æ±‚ä½ å¿…é¡»å¯¹JVMå†…éƒ¨ç»“æ„åŒ…æ‹¬classæ–‡ä»¶çš„æ ¼å¼å’ŒæŒ‡ä»¤é›†éƒ½å¾ˆç†Ÿæ‚‰. 

æ ¸å¿ƒæ­¥éª¤ï¼š
* å¯¼å…¥CglibåŒ…
* åˆ›å»ºæ¥å£ï¼ˆå®ç°ï¼‰æˆ–ç±»
* åˆ›å»ºä»£ç†ç±»å®ç°MethodInterceptor é‡å†™intercept è¿”å›ç›®æ ‡å¯¹è±¡
* åˆ›å»ºä»£ç†ç±»å¯¹è±¡å®ç°å¯¹ç›®æ ‡å¯¹è±¡çš„ä»£ç†

âœğŸ»ä¸Šä»£ç :
```java
/**
 * @author xianglei
 * åˆ›å»ºdaoæ¥å£
 */
public interface UserDao {
     public void add();
}
/**
 * @author xianglei
 * å®ç°æ¥å£
 */
public class UserDaoImpl implements UserDao {
    @Override
    public void add() {
        System.out.println("å­˜å…¥æ•°æ®");
    }
}
/**
*ä¸æ˜¯ç”¨æ¥å£åœºæ™¯
*/
public /*final*/ class People {
    public /*final*/ void sing(){
        System.out.println("äººä¼šå”±æ­Œ");
    }
}
/**
 * @author xianglei
 * cglib å®ç°åŠ¨æ€ä»£ç†
 */
public class ClientCgLib implements MethodInterceptor {
    private Object targetObject;
    /**
     *  è¿™é‡Œçš„ç›®æ ‡ç±»å‹ä¸ºObjectï¼Œåˆ™å¯ä»¥æ¥å—ä»»æ„ä¸€ç§å‚æ•°ä½œä¸ºè¢«ä»£ç†ç±»ï¼Œå®ç°äº†åŠ¨æ€ä»£ç†
     */

    public Object getInstance(Object target) {
        // è®¾ç½®éœ€è¦åˆ›å»ºå­ç±»çš„ç±»
        this.targetObject = target;
        //åˆ›å»ºåŠ å¼ºå™¨ï¼Œç”¨æ¥åˆ›å»ºåŠ¨æ€ä»£ç†ç±»
        Enhancer enhancer = new Enhancer();
        //ä¸ºåŠ å¼ºå™¨æŒ‡å®šè¦ä»£ç†çš„ä¸šåŠ¡ç±»ï¼ˆå³ï¼šä¸ºä¸‹é¢ç”Ÿæˆçš„ä»£ç†ç±»æŒ‡å®šçˆ¶ç±»ï¼‰
        enhancer.setSuperclass(target.getClass());
        //è®¾ç½®å›è°ƒï¼šå¯¹äºä»£ç†ç±»ä¸Šæ‰€æœ‰æ–¹æ³•çš„è°ƒç”¨ï¼Œéƒ½ä¼šè°ƒç”¨CallBackï¼Œè€ŒCallbackåˆ™éœ€è¦å®ç°intercept()æ–¹æ³•è¿›è¡Œæ‹¦
        enhancer.setCallback(this);
        return enhancer.create();
    }

    @Override
    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
        System.out.println("å¼€å¯äº‹åŠ¡");
        Object result = methodProxy.invoke(targetObject, objects);
        System.out.println("å…³é—­äº‹åŠ¡");
        // è¿”å›ä»£ç†å¯¹è±¡
        return result;
    }

    public static void main(String[] args) {
        ClientCgLib cglibProxy = new ClientCgLib();
        People people= (People)cglibProxy.getInstance(new People());
        people.sing();
       /* UserDao userDao = (UserDao) cglibProxy.getInstance(new UserDaoImpl());
        userDao.add();*/
    }

}

```
ğŸ™‹æ³¨æ„ï¼š
ä½¿ç”¨cglib[Code Generation Library]å®ç°åŠ¨æ€ä»£ç†ï¼Œ**å¹¶ä¸è¦æ±‚**å§”æ‰˜ç±»å¿…é¡»å®ç°æ¥å£ï¼Œåº•å±‚é‡‡ç”¨asmå­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç ã€‚åœ¨Springçš„AOPç¼–ç¨‹ä¸­:å¦‚æœåŠ å…¥å®¹å™¨çš„ç›®æ ‡å¯¹è±¡æœ‰å®ç°æ¥å£,ç”¨JDKä»£ç†å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£,ç”¨Cglibä»£ç†ã€‚

---
## æ€»ç»“

JavaåŠ¨æ€ä»£ç†æ˜¯åˆ©ç”¨**åå°„æœºåˆ¶**ç”Ÿæˆä¸€ä¸ªå®ç°ä»£ç†æ¥å£çš„åŒ¿åç±»ï¼Œåœ¨è°ƒç”¨å…·ä½“æ–¹æ³•å‰è°ƒç”¨InvokeHandleræ¥å¤„ç†ã€‚è€ŒcglibåŠ¨æ€ä»£ç†æ˜¯åˆ©ç”¨asmå¼€æºåŒ…ï¼Œå¯¹ä»£ç†å¯¹è±¡ç±»çš„classæ–‡ä»¶åŠ è½½è¿›æ¥ï¼Œé€šè¿‡ä¿®æ”¹å…¶å­—èŠ‚ç ç”Ÿæˆ**å­ç±»**æ¥å¤„ç†ã€‚

1. JDKåŠ¨æ€ä»£ç†æ˜¯å®ç°äº†è¢«ä»£ç†å¯¹è±¡çš„æ¥å£ï¼ŒCglibæ˜¯ç»§æ‰¿äº†è¢«ä»£ç†å¯¹è±¡ã€‚
2. JDKå’ŒCglibéƒ½æ˜¯åœ¨è¿è¡ŒæœŸç”Ÿæˆå­—èŠ‚ç ï¼ŒJDKæ˜¯ç›´æ¥å†™Classå­—èŠ‚ç ï¼ŒCglibä½¿ç”¨ASMæ¡†æ¶å†™Classå­—èŠ‚ç ï¼ŒCglibä»£ç†å®ç°æ›´å¤æ‚ï¼Œç”Ÿæˆä»£ç†ç±»æ¯”JDKæ•ˆç‡ä½ã€‚
3. JDKè°ƒç”¨ä»£ç†æ–¹æ³•ï¼Œæ˜¯é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨ï¼ŒCglibæ˜¯é€šè¿‡FastClassæœºåˆ¶ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼ŒCglibæ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚ç”±äºCGLibç”±äºæ˜¯é‡‡ç”¨åŠ¨æ€åˆ›å»ºå­ç±»çš„æ–¹æ³•ï¼Œå¯¹äºfinalä¿®é¥°çš„æ–¹æ³•æ— æ³•è¿›è¡Œä»£ç†ã€‚